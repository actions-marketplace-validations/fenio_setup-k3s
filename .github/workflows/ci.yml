name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-k3s-functionality:
    runs-on: ubuntu-latest
    name: Test k3s Functionality
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup k3s
        id: k3s
        uses: ./
        with:
          version: stable
          wait-for-ready: true
          timeout: 120
      
      - name: Verify k3s is installed and running
        run: |
          echo "=== Verifying k3s Installation ==="
          which k3s && echo "✓ k3s binary found at $(which k3s)" || (echo "✗ k3s binary not found" && exit 1)
          sudo systemctl is-active k3s && echo "✓ k3s service is active" || (echo "✗ k3s service not active" && exit 1)
      
      - name: Verify cluster
        env:
          KUBECONFIG: ${{ steps.k3s.outputs.kubeconfig }}
        run: |
          echo "=== Cluster Info ==="
          kubectl cluster-info
          
          echo "=== Nodes ==="
          kubectl get nodes -o wide
          
          echo "=== System Pods ==="
          kubectl get pods -n kube-system
          
          echo "=== Deploy test workload ==="
          kubectl create deployment nginx --image=nginx:alpine
          kubectl wait --for=condition=available --timeout=120s deployment/nginx
          
          POD_NAME=$(kubectl get pod -l app=nginx -o jsonpath='{.items[0].metadata.name}')
          kubectl exec $POD_NAME -- wget -O- http://localhost:80 | grep -q "Welcome to nginx"
          
          echo "✓ All tests passed!"
